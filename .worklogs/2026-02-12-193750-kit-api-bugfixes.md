# Fix Kit API v4 field update and tag removal endpoints

**Date:** 2026-02-12 19:37
**Scope:** landing/src/lib/kit-api.ts

## Summary
Fixed two bugs in the Kit API helper discovered during browser end-to-end testing: (1) POST /subscribers doesn't update custom fields on existing subscribers, and (2) tag removal endpoint URL had subscriber/tag IDs in wrong order.

## Context & Problem
Browser test of quiz gate flow showed the API returning 200 and the frontend working correctly (gate bypassed, results shown, localStorage set), but Kit subscriber data wasn't being updated:
- `quiz_result_url` still showed value from first curl test, not the browser submission URL
- `Quiz Completed` tag `tagged_at` timestamp was unchanged after fromGate:true remove+re-add

## Decisions Made

### POST doesn't update fields on existing subscribers
- **Chose:** Two-step approach: POST to create/retrieve subscriber, then PUT /subscribers/{id} to update fields
- **Why:** Kit v4's `POST /v4/subscribers` is idempotent for creation but silently ignores `fields` on existing subscribers. Only `PUT /v4/subscribers/{id}` updates custom fields.
- **Evidence:** After fix, `quiz_result_url` correctly updated on existing subscriber (verified via Kit MCP)

### Tag removal endpoint URL was inverted
- **Chose:** Changed from `DELETE /v4/subscribers/{subscriber_id}/tags/{tag_id}` to `DELETE /v4/tags/{tag_id}/subscribers/{subscriber_id}`
- **Why:** Kit v4 docs at developers.kit.com/api-reference/tags/remove-tag-from-subscriber.md explicitly specify the tag-centric URL format
- **Evidence:** After fix, `Quiz Completed` tag `tagged_at` updated from 19:14:56Z to 19:35:29Z (curl) and 19:37:04Z (browser) — confirming remove+re-add works

## Test Results
- curl fromGate:false → fields updated correctly (quiz_result_url and timezone both changed)
- curl fromGate:true → Quiz Completed tag timestamp updated (19:14:56Z → 19:35:29Z)
- Browser end-to-end: new subscriber `browser-test@steady-parent.com` created with all correct tags (lead, quiz-parenting-style, Quiz Completed) and fields (quiz_result_url, timezone: Europe/Lisbon)

## Key Files for Context
- `landing/src/lib/kit-api.ts` — the fixed file
- `.worklogs/2026-02-12-191713-quiz-gate-implementation.md` — prior implementation worklog
